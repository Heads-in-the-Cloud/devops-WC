---
- hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - eks_vars.yaml
    
  tasks:
      ##########################
      ######  Get VPC ID  ######
      ##########################
    - name: Getting VPC info
      ec2_vpc_net_info:
        region: "{{ REGION }}"
        filters:
          "tag:Name": "{{VPC_NAME}}"
      register: vpc
      

    - name: Setting vpc_id fact
      set_fact:
        vpc_id: "{{ vpc.vpcs[0].vpc_id }}"


      ##############################
      ######  Get Subnet IDs  ######
      ##############################
    - name: Getting private subnets info
      ec2_vpc_subnet_info:
        region: "{{ REGION }}"
        filters:
          vpc-id: "{{ vpc_id }}"
          "tag:kubernetes.io/role/internal-elb": "1"
          "tag:kubernetes.io/cluster/UtopiaClusterWC": "shared"
      loop:
        - subnet1
        - subnet2
      register: subnets

    - name: Setting subnet1 fact
      set_fact:
        subnet1: "{{ subnets.results[0].subnets[0].id }}"

    - name: Setting subnet2 fact
      set_fact:
        subnet2: "{{ subnets.results[0].subnets[1].id }}"

    - name: debug
      debug:
        msg: "{{ subnet1 }}"

    - name: debug
      debug:
        msg: "{{ subnet2 }}"

      ##############################
      ######  Create Cluster  ######
      ##############################
     
    # - name: Create EKS cluster
    #   shell: |
    #     eksctl create cluster --name="{{ CLUSTER_NAME }}" --region="{{ REGION }}" --fargate \
    #     --vpc-private-subnets="{{subnet1}},{{subnet2}}"

    # - name: Associate Open ID Provider
    #   shell: |
    #     eksctl utils associate-iam-oidc-provider --cluster="{{ CLUSTER_NAME }}" --approve
  
    # - name: Create ALB Ingress Controller
    #   shell: |
    #     kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/rbac-role.yaml"
    #     eksctl create iamserviceaccount \
    #       --name=alb-ingress-controller \
    #       --namespace=kube-system \
    #       --cluster="{{ CLUSTER_NAME }}" \
    #       --attach-policy-arn="arn:aws:iam::{{ AWS_ACCOUNT_ID }}}:policy/ALBIngressControllerIAMPolicy" \
    #       --override-existing-serviceaccounts \
    #       --approve

    #     curl -sS 'https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.4/docs/examples/alb-ingress-controller.yaml' \
    #         | sed "s/# - --cluster-name=devCluster/- --cluster-name={{ CLUSTER_NAME }}/g" \
    #         | sed "s/# - --aws-vpc-id=vpc-xxxxxx/- --aws-vpc-id={{ VPC_ID }}}/g" \
    #         | sed "s/# - --aws-region=us-west-1/- --aws-region={{ REGION }}/g" \
    #         | kubectl apply -f -        

