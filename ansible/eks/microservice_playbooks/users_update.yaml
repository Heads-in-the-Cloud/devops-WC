---
- hosts: localhost
  connection: local
  gather_facts: false
  tasks:

    ########################
    #### Switch Context ####
    ########################

    - name: Switch Context to Cluster
      block:
      - name: Try updating kubeconfig
        shell: aws eks --region "{{ REGION }}" update-kubeconfig --name "{{ CLUSTER_NAME }}"
      - name: Rollout Restart Deployment
        shell: |
          kubectl rollout restart deployments/users-deployment
      rescue:
      - name: Catch cluster does not exist
        ignore_errors: yes
        shell: aws eks --region "{{ REGION }}" update-kubeconfig --name "{{ CLUSTER_NAME }}"
        register: cluster_err
        
    - name: Print error to stdout
      set_stats:
        data:
          JENKINS_EXPORT:
            - value: "{{ cluster_err.stdout }}"


    
