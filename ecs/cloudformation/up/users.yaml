AWSTemplateFormatVersion: 2010-09-09
Conditions:
  # CreateResources: !Or [ !Equals [!Ref EnvType, "prod"], !Equals [!Ref EnvType, "dev"] ]
  ProdEnv: !Equals [!Ref EnvType, "prod"]
  # NotProdEnv: !Not [Condition: ProdEnv]



Parameters:
  IamRole:
    Type: String
    Description: Task Defintion taskExecutionRoleArn
  EnvType:
    Type: String
    Default: dev
  AccountId:
    Type: String
    Description: Team Account Id
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: Select a VPC that allows instances to access the Internet.
  PublicSubnet1:
    Type: AWS::EC2::Subnet::Id
    Description: Public subnets for the load balancer
  PublicSubnet2:
    Type: AWS::EC2::Subnet::Id
  ContainerPort:
    Type: Number
    Default: 5000
    Description: port to use for task def/target group/service
  ClusterName:
    Type: String
    Description: ECS cluster name
  Region:
    Type: String
    Description: AWS region to deploy to
  CertificateArn:
    Type: String
    Default: nothing

  #Task definition parameters
  UsersRepo:
    Type: String
    Description: ECR image for users

  UsersFamily:
    Type: String
    Description: Users task definition family
  #https://stackoverflow.com/questions/57213974/aws-cloudformation-containerdefinitions-secrets-assigning-full-secretstring-for
  SSMSecretString:
    Type: String
    Description: the secret string path to access SSM 
  DbHost:
    Type: String
    Description: SSM db host path
  DbUser:
    Type: String
    Description: SSM db username path
  DbPassword:
    Type: String
    Description: SSM db password path
  SecretKey:
    Type: String
    Description: SSM secret key path

  #Target Group Parameters
  UsersHealthCheck:
    Type: String
    Description: health check path


  #Route53 Parameters
  HostedZoneId:
    Type: String
    Description: Hosted Zone ID for HITWC
  RecordName:
    Type: String
    Description: full DNS of our record

Resources:

  ALBListenerHTTPS:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Condition: ProdEnv
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroupBlue
      Certificates: 
        - CertificateArn: !Ref CertificateArn
      LoadBalancerArn: !Ref ECSALB
      Port: '443'
      Protocol: HTTPS
  ListenerRuleReady:
    Type: AWS::CloudFormation::WaitConditionHandle
    Metadata:
      ListenerReady: !If [ ProdEnv, !Ref ALBListenerHTTPS, !Ref ALBListenerHTTP ]

  ECSCluster:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterName: !Ref ClusterName
      Tags:
        - Key: Name
          Value: !Ref ClusterName
  AlbSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Alb Security Group
      VpcId: !Ref VpcId
  AlbSecurityGroupInbound:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref AlbSecurityGroup
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80
      CidrIp: 0.0.0.0/0
  EcsSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: ECS Security Group
      VpcId: !Ref VpcId
  EcsSecurityGroupHTTPinbound:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref EcsSecurityGroup
      IpProtocol: tcp
      FromPort: !Ref ContainerPort
      ToPort: !Ref ContainerPort
      SourceSecurityGroupId: !Ref AlbSecurityGroup

  ECSTaskExecutionRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy'
  BlueTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Ref UsersFamily
      ContainerDefinitions:
        - Name: !Ref UsersFamily
          Essential: 'true'
          Image: !Join [ '', [!Ref AccountId, '.dkr.ecr.', !Ref Region, '.amazonaws.com/', !Ref UsersRepo ]]
          PortMappings:
            - HostPort: !Ref ContainerPort
              Protocol: tcp
              ContainerPort: !Ref ContainerPort
          Environment: 
            - Name: USERS_PORT
              Value: !Ref ContainerPort
            - Name: DB_HOST
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbHost, '}}' ] ]
            - Name: DB_USER
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbUser, '}}' ] ]
            - Name: DB_USER_PASSWORD
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbPassword, '}}' ] ]
            - Name: SECRET_KEY
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref SecretKey, '}}' ] ]
      Cpu: 1vCPU
      Memory: 2GB
      ExecutionRoleArn: !GetAtt 
        - ECSTaskExecutionRole
        - Arn      
      NetworkMode: "awsvpc"
      RequiresCompatibilities:
        - FARGATE
      TaskRoleArn: !Ref IamRole #arn:aws:iam::026390315914:role/WC-ecs-task-iam-role

  ECSALB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: ECSALB
      Scheme: internet-facing
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: '30'
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref AlbSecurityGroup
      Type: application
      IpAddressType: ipv4

  ALBListenerHTTP:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Properties:
      DefaultActions:
      - Type: forward
        ForwardConfig:
          TargetGroups:
            - TargetGroupArn: !Ref ALBTargetGroupBlue
              Weight: 1
      LoadBalancerArn: !Ref ECSALB
      Port: '80'
      Protocol: HTTP

  ALBTargetGroupBlue:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    DependsOn: ECSALB
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: !Ref UsersHealthCheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Name: ALBTargetGroupBlue
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref VpcId
      TargetType: ip
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
  ALBTargetGroupGreen:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    DependsOn: ECSALB
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: !Ref UsersHealthCheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Name: ALBTargetGroupGreen
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref VpcId
      TargetType: ip
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
  UsersService:
    Type: 'AWS::ECS::Service'
    DependsOn: ListenerRuleReady
    Properties:
      ServiceName: !Ref UsersRepo
      Cluster: !Ref ECSCluster
      DesiredCount: 2
      LaunchType: "FARGATE"
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: "ENABLED"
          SecurityGroups: 
            - !Ref EcsSecurityGroup
          Subnets: 
            - !Ref PublicSubnet1
            - !Ref PublicSubnet2
      LoadBalancers:
        - ContainerName: !Ref UsersFamily
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref ALBTargetGroupBlue
      TaskDefinition: !Ref BlueTaskDefinition
      DeploymentController:
        Type: CODE_DEPLOY
      Tags:
        - Key: Name
          Value: UsersService
  UsersApplication:
    Type: AWS::CodeDeploy::Application
    Properties: 
      ApplicationName: !Ref UsersFamily
      ComputePlatform: ECS
      Tags: 
        - Key: Name
          Value: !Ref UsersFamily
  UsersDeploymentGroup:
    Type: AWS::CodeDeploy::DeploymentGroup
    Properties:
      ApplicationName: !Ref UsersFamily
      DeploymentGroupName: users-deployment-group
      DeploymentStyle: 
          DeploymentType: BLUE_GREEN
      ECSServices: 
        - ClusterName: !Ref ECSCluster
          ServiceName: !GetAtt UsersService.Name
      # LoadBalancerInfo: 
      #   LoadBalancerInfo
      ServiceRoleArn: arn:aws:iam::026390315914:role/CodeDeployServiceRole



  Route53:
    Type: AWS::Route53::RecordSet
    Properties: 
      ResourceRecords:
        - !GetAtt ECSALB.DNSName
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref RecordName
      Type: 'CNAME'
      TTL: '300'
