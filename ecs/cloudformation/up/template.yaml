AWSTemplateFormatVersion: 2010-09-09

Conditions:
  CreateResources: !Or [ !Equals [!Ref EnvType, "prod"], !Equals [!Ref EnvType, "dev"] ]
  ProdEnv: !Equals [!Ref EnvType, "prod"]
  NotProdEnv: !Not [Condition: ProdEnv]


Parameters:
  EnvType:
    Description: Environment type.
    Default: test
    Type: String
    AllowedValues: [prod, dev, test]
    ConstraintDescription: must specify prod, dev, or test.

  AccountId:
    Type: String
    Description: Team Account Id
  VpcId:
    Type: 'AWS::EC2::VPC::Id'
    Description: Select a VPC that allows instances to access the Internet.
  PublicSubnet1:
    Type: String
    Description: Public subnets for the load balancer
  PublicSubnet2:
    Type: String
  PrivateSubnet1:
    Type: String
    Description: Private subnets for the services
  PrivateSubnet2:
    Type: String
  ContainerPort:
    Type: Number
    Default: 5000
    Description: port to use for task def/target group/service
  ClusterName:
    Type: String
    Description: ECS cluster name
  Region:
    Type: String
    Description: AWS region to deploy to

  #Task definition parameters
  UsersRepo:
    Type: String
    Description: ECR image for users
  FlightsRepo:
    Type: String
    Description: ECR image for flights
  BookingsRepo:
    Type: String
    Description: ECR image for bookings
  FrontendRepo:
    Type: String
    Description: ECR image for frontend
  IamRole:
    Type: String
    Description: Task Defintion taskExecutionRoleArn
  UsersFamily:
    Type: String
    Description: Users task definition family
  FlightsFamily:
    Type: String
    Description: Flights task definition family
  BookingsFamily:
    Type: String
    Description: Bookings task definition family
  FrontendFamily:
    Type: String
    Description: Frontend task definition family
  LogGroupName:
    Type: String
    Description: name of log group

  #https://stackoverflow.com/questions/57213974/aws-cloudformation-containerdefinitions-secrets-assigning-full-secretstring-for
  SSMSecretString:
    Type: String
    Description: the secret string path to access SSM 
  DbHost:
    Type: String
    Description: SSM db host path
  DbUser:
    Type: String
    Description: SSM db username path
  DbPassword:
    Type: String
    Description: SSM db password path
  SecretKey:
    Type: String
    Description: SSM secret key path

  #Target Group Parameters
  UsersHealthCheck:
    Type: String
    Description: health check path
  FlightsHealthCheck:
    Type: String
  BookingsHealthCheck:
    Type: String
  FrontendHealthCheck:
    Type: String

  #ALB Listener Parameters
  UsersPath:
    Type: String
    Description: Ingress path prefix rules
  FlightsPath:
    Type: String
  BookingsPath:
    Type: String
  FrontendPath:
    Type: String

  #Route53 Parameters
  HostedZoneId:
    Type: String
    Description: Hosted Zone ID for HITWC
  RecordName:
    Type: String
    Description: full DNS of our record
  CertificateArn:
    Type: String
    Description: certificate arn for prod environment

Resources:
  ECSCluster:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterName: !Ref ClusterName
      Tags:
        - Key: Name
          Value: !Ref ClusterName
  AlbSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Alb Security Group
      VpcId: !Ref VpcId
  AlbSecurityGroupInbound:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref AlbSecurityGroup
      IpProtocol: tcp
      FromPort: !If [ ProdEnv, 443, 80 ]
      ToPort: !If [ ProdEnv, 443, 80 ]
      CidrIp: 0.0.0.0/0
  # AlbSecurityGroupHTTPSinbound:
  #   Type: 'AWS::EC2::SecurityGroupIngress'
  #   Condition: ProdEnv
  #   Properties:
  #     GroupId: !Ref AlbSecurityGroup
  #     IpProtocol: tcp
  #     FromPort: 443
  #     ToPort: 443
  #     CidrIp: 0.0.0.0/0

  EcsSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: ECS Security Group
      VpcId: !Ref VpcId
  EcsSecurityGroupHTTPinbound:
    Type: 'AWS::EC2::SecurityGroupIngress'
    Properties:
      GroupId: !Ref EcsSecurityGroup
      IpProtocol: tcp
      FromPort: !Ref ContainerPort
      ToPort: !Ref ContainerPort
      SourceSecurityGroupId: !Ref AlbSecurityGroup


  UsersTaskDef:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Ref UsersFamily
      ContainerDefinitions:
        - Name: !Ref UsersFamily
          Cpu: '10'
          Essential: 'true'
          Image: !Join [ '', [!Ref AccountId, '.dkr.ecr.', !Ref Region, '.amazonaws.com/', !Ref UsersRepo ]]
          Memory: '300'
          PortMappings: 
            - ContainerPort: !Ref ContainerPort
          Environment: 
            - Name: USERS_PORT
              Value: !Ref ContainerPort
            - Name: DB_HOST
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbHost, '}}' ] ]
            - Name: DB_USER
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbUser, '}}' ] ]
            - Name: DB_USER_PASSWORD
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbPassword, '}}' ] ]
            - Name: SECRET_KEY
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref SecretKey, '}}' ] ]
          LogConfiguration:
            LogDriver: awsfirelens
            Options:
              # awslogs-region: !Ref Region
              # awslogs-group: !Ref myLogGroup
              # awslogs-stream-prefix: /users-taskdef
              Name: es
              Host: elk-docker-compose.hitwc.link
              Port: 5000
              Index: users
        - Name: log_router
          Essential: 'true'
          Image: docker.io/amazon/aws-for-fluent-bit:latest
      Cpu: "1vCPU"
      ExecutionRoleArn: !Ref IamRole
      Memory: "2GB"
      NetworkMode: "awsvpc"
      RequiresCompatibilities: 
        - "FARGATE"
      TaskRoleArn: !Ref IamRole
  FlightsTaskDef:
    Type: 'AWS::ECS::TaskDefinition'
    Condition: CreateResources
    Properties:
      Family: !Ref FlightsFamily
      ContainerDefinitions: 
        - Name: !Ref FlightsFamily
          Image: !Join [ '', [!Ref AccountId, '.dkr.ecr.us-west-2.amazonaws.com/', !Ref FlightsRepo ]]
          Cpu: '10'
          Memory: '300'
          Essential: 'true'
          PortMappings: 
            - ContainerPort: !Ref ContainerPort
          Environment: 
            - Name: FLIGHTS_PORT
              Value: !Ref ContainerPort
            - Name: DB_HOST
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbHost, '}}' ] ]
            - Name: DB_USER
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbUser, '}}' ] ]
            - Name: DB_USER_PASSWORD
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbPassword, '}}' ] ]
            - Name: SECRET_KEY
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref SecretKey, '}}' ] ]
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref Region
              awslogs-group: !Ref myLogGroup
              awslogs-stream-prefix: /flights-taskdef
      Cpu: "1vCPU"
      ExecutionRoleArn: !Ref IamRole
      Memory: "2GB"
      NetworkMode: "awsvpc"
      RequiresCompatibilities: 
        - "FARGATE"
      TaskRoleArn: !Ref IamRole

  BookingsTaskDef:
    Type: 'AWS::ECS::TaskDefinition'
    Condition: CreateResources
    Properties:
      Family: !Ref BookingsFamily
      ContainerDefinitions: 
        - Name: !Ref BookingsFamily
          Image: !Join [ '', [!Ref AccountId, '.dkr.ecr.us-west-2.amazonaws.com/', !Ref BookingsRepo ]]
          Cpu: '10'
          Memory: '300'
          Essential: 'true'
          PortMappings: 
            - ContainerPort: !Ref ContainerPort
          Environment: 
            - Name: BOOKINGS_PORT
              Value: !Ref ContainerPort
            - Name: DB_HOST
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbHost, '}}' ] ]
            - Name: DB_USER
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbUser, '}}' ] ]
            - Name: DB_USER_PASSWORD
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref DbPassword, '}}' ] ]
            - Name: SECRET_KEY
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref SecretKey, '}}' ] ]
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref Region
              awslogs-group: !Ref myLogGroup
              awslogs-stream-prefix: /bookings-taskdef
      Cpu: "1vCPU"
      ExecutionRoleArn: !Ref IamRole
      Memory: "2GB"
      NetworkMode: "awsvpc"
      RequiresCompatibilities: 
        - "FARGATE"
      TaskRoleArn: !Ref IamRole

  FrontendTaskDef:
    Type: 'AWS::ECS::TaskDefinition'
    Condition: CreateResources
    Properties:
      Family: !Ref FrontendFamily
      ContainerDefinitions: 
        - Name: !Ref FrontendFamily
          Image: !Join [ '', [!Ref AccountId, '.dkr.ecr.us-west-2.amazonaws.com/', !Ref FrontendRepo ]]
          Cpu: '10'
          Memory: '300'
          Essential: 'true'
          PortMappings: 
            - ContainerPort: !Ref ContainerPort
          Environment: 
            - Name: FRONTEND_PORT
              Value: !Ref ContainerPort
            - Name: HOST_DOMAIN
              Value: !If [ ProdEnv, !Join [ '', [ 'https://', !Ref RecordName ] ], !Join [ '', [ 'http://', !Ref RecordName ] ] ]
            - Name: SECRET_KEY
              Value: !Join [ '', [ '{{resolve:secretsmanager:', !Ref SSMSecretString, ':SecretString:', !Ref SecretKey, '}}' ] ]
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-region: !Ref Region
              awslogs-group: !Ref myLogGroup
              awslogs-stream-prefix: /frontend-taskdef
      Cpu: "1vCPU"
      ExecutionRoleArn: !Ref IamRole
      Memory: "2GB"
      NetworkMode: "awsvpc"
      RequiresCompatibilities: 
        - "FARGATE"
      TaskRoleArn: !Ref IamRole

  ECSALB:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: ECSALB
      Scheme: internet-facing
      LoadBalancerAttributes:
        - Key: idle_timeout.timeout_seconds
          Value: '30'
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref AlbSecurityGroup
  ALBListenerHTTPS:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Condition: ProdEnv
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref UsersTG
      Certificates: 
        - CertificateArn: !Ref CertificateArn
      LoadBalancerArn: !Ref ECSALB
      Port: '443'
      Protocol: HTTPS
  ALBListenerHTTP:
    Type: 'AWS::ElasticLoadBalancingV2::Listener'
    Condition: NotProdEnv
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref UsersTG
      LoadBalancerArn: !Ref ECSALB
      Port: '80'
      Protocol: HTTP
  FlightsListenerRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Condition: CreateResources
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref FlightsTG
      Conditions:
        - Field: path-pattern
          Values:
            - !Ref FlightsPath
      ListenerArn: !If [ProdEnv, !Ref ALBListenerHTTPS, !Ref ALBListenerHTTP]
      Priority: 1
  BookingsListenerRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Condition: CreateResources
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref BookingsTG
      Conditions:
        - Field: path-pattern
          Values:
            - !Ref BookingsPath
      ListenerArn: !If [ProdEnv, !Ref ALBListenerHTTPS, !Ref ALBListenerHTTP]
      Priority: 2
  FrontendListenerRule:
    Type: 'AWS::ElasticLoadBalancingV2::ListenerRule'
    Condition: CreateResources
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref FrontendTG
      Conditions:
        - Field: path-pattern
          Values:
            - !Ref FrontendPath
      ListenerArn: !If [ProdEnv, !Ref ALBListenerHTTPS, !Ref ALBListenerHTTP]
      Priority: 3
  UsersTG:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    DependsOn: ECSALB
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: !Ref UsersHealthCheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Name: UsersTG
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref VpcId
      TargetType: ip
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
  FlightsTG:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Condition: CreateResources
    DependsOn: ECSALB
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: !Ref FlightsHealthCheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Name: FlightsTG
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref VpcId
      TargetType: ip
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
  BookingsTG:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Condition: CreateResources
    DependsOn: ECSALB
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: !Ref BookingsHealthCheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Name: BookingsTG
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref VpcId
      TargetType: ip
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
  FrontendTG:
    Type: 'AWS::ElasticLoadBalancingV2::TargetGroup'
    Condition: CreateResources
    DependsOn: ECSALB
    Properties:
      HealthCheckIntervalSeconds: 10
      HealthCheckPath: !Ref FrontendHealthCheck
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      Name: FrontendTG
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 2
      VpcId: !Ref VpcId
      TargetType: ip
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
  ListenerRuleReady:
    Type: AWS::CloudFormation::WaitConditionHandle
    Metadata:
      ListenerReady: !If [ ProdEnv, !Ref ALBListenerHTTPS, !Ref ALBListenerHTTP ]
  UsersService:
    Type: 'AWS::ECS::Service'
    DependsOn: ListenerRuleReady
    Properties:
      ServiceName: !Ref UsersRepo
      Cluster: !Ref ECSCluster
      DesiredCount: !If [ProdEnv, 2, 1]
      LaunchType: "FARGATE"
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: "ENABLED"
          SecurityGroups: 
            - !Ref EcsSecurityGroup
          Subnets: 
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
      LoadBalancers:
        - ContainerName: !Ref UsersFamily
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref UsersTG
      TaskDefinition: !Ref UsersTaskDef
      Tags:
        - Key: Name
          Value: UsersService
  FlightsService:
    Type: 'AWS::ECS::Service'
    Condition: CreateResources
    DependsOn: FlightsListenerRule
    Properties:
      ServiceName: !Ref FlightsRepo
      Cluster: !Ref ECSCluster
      DesiredCount: !If [ProdEnv, 2, 1]
      LaunchType: "FARGATE"
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: "ENABLED"
          SecurityGroups: 
            - !Ref EcsSecurityGroup
          Subnets: 
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
      LoadBalancers:
        - ContainerName: !Ref FlightsFamily
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref FlightsTG
      TaskDefinition: !Ref FlightsTaskDef
      Tags:
        - Key: Name
          Value: FlightsService
  BookingsService:
    Type: 'AWS::ECS::Service'
    Condition: CreateResources
    DependsOn: BookingsListenerRule
    Properties:
      ServiceName: !Ref BookingsRepo
      Cluster: !Ref ECSCluster
      DesiredCount: !If [ProdEnv, 2, 1]
      LaunchType: "FARGATE"
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: "ENABLED"
          SecurityGroups: 
            - !Ref EcsSecurityGroup
          Subnets: 
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
      LoadBalancers:
        - ContainerName: !Ref BookingsFamily
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref BookingsTG
      TaskDefinition: !Ref BookingsTaskDef
      Tags:
        - Key: Name
          Value: BookingsService
  FrontendService:
    Type: 'AWS::ECS::Service'
    Condition: CreateResources
    DependsOn: FrontendListenerRule
    Properties:
      ServiceName: !Ref FrontendRepo
      Cluster: !Ref ECSCluster
      DesiredCount: !If [ProdEnv, 2, 1]
      LaunchType: "FARGATE"
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: "ENABLED"
          SecurityGroups: 
            - !Ref EcsSecurityGroup
          Subnets: 
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
      LoadBalancers:
        - ContainerName: !Ref FrontendFamily
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref FrontendTG
      TaskDefinition: !Ref FrontendTaskDef
      Tags:
        - Key: Name
          Value: FrontendService
  Route53:
    Type: AWS::Route53::RecordSet
    Properties: 
      ResourceRecords:
        - !GetAtt ECSALB.DNSName
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref RecordName
      Type: 'CNAME'
      TTL: '300'
  myLogGroup: 
    Type: AWS::Logs::LogGroup
    Properties: 
      LogGroupName: !Ref LogGroupName
      RetentionInDays: 1